{"title":"08.React源码学习-commit","date":"2019-12-02T02:25:29.000Z","date_formatted":{"ll":"2019年12月2日","L":"2019/12/02","MM-DD":"12-02"},"author":"zao","link":"2019/12/02/note/08-React源码学习-commit","tags":["react源码"],"categories":["note"],"updated":"2019-12-02T02:25:29.000Z","content":"<h2 id=\"commit\">commit<a href=\"#commit\" title=\"commit\"></a></h2><p>首先要标记优先级，因为有一部分优先级的任务已经被提交了，所以需要清楚一些相关的优先级。被提交的任务应该是：</p>\n<ul><li>子树中优先级最高的任务</li>\n<li>或者外部指定的优先级（flushSync或者retry）</li>\n</ul><p>如果 <code>RootFiber</code> 本身也有副作用（一般只有第一次），那么他本身也要加到 <code>effect</code> 链上，放在最后。接下去是三个提交操作，分别是:</p>\n<ul><li>提交Snapshot</li>\n<li>提交HostComponent的 side effect`</li>\n<li>提交所有组件的生命周期</li>\n</ul><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function commitRoot(root: FiberRoot, finishedWork: Fiber): void &#123;</span><br><span class=\"line\">  isWorking &#x3D; true</span><br><span class=\"line\">  isCommitting &#x3D; true</span><br><span class=\"line\">  startCommitTimer()</span><br><span class=\"line\"></span><br><span class=\"line\">  invariant(</span><br><span class=\"line\">    root.current !&#x3D;&#x3D; finishedWork,</span><br><span class=\"line\">    &#39;Cannot commit the same tree as before. This is probably a bug &#39; +</span><br><span class=\"line\">      &#39;related to the return field. This error is likely caused by a bug &#39; +</span><br><span class=\"line\">      &#39;in React. Please file an issue.&#39;,</span><br><span class=\"line\">  )</span><br><span class=\"line\">  const committedExpirationTime &#x3D; root.pendingCommitExpirationTime</span><br><span class=\"line\">  invariant(</span><br><span class=\"line\">    committedExpirationTime !&#x3D;&#x3D; NoWork,</span><br><span class=\"line\">    &#39;Cannot commit an incomplete root. This error is likely caused by a &#39; +</span><br><span class=\"line\">      &#39;bug in React. Please file an issue.&#39;,</span><br><span class=\"line\">  )</span><br><span class=\"line\">  root.pendingCommitExpirationTime &#x3D; NoWork</span><br><span class=\"line\"></span><br><span class=\"line\">  const updateExpirationTimeBeforeCommit &#x3D; finishedWork.expirationTime</span><br><span class=\"line\">  const childExpirationTimeBeforeCommit &#x3D; finishedWork.childExpirationTime</span><br><span class=\"line\">  const earliestRemainingTimeBeforeCommit &#x3D;</span><br><span class=\"line\">    updateExpirationTimeBeforeCommit &#x3D;&#x3D;&#x3D; NoWork ||</span><br><span class=\"line\">    (childExpirationTimeBeforeCommit !&#x3D;&#x3D; NoWork &amp;&amp;</span><br><span class=\"line\">      childExpirationTimeBeforeCommit &lt; updateExpirationTimeBeforeCommit)</span><br><span class=\"line\">      ? childExpirationTimeBeforeCommit</span><br><span class=\"line\">      : updateExpirationTimeBeforeCommit</span><br><span class=\"line\">  markCommittedPriorityLevels(root, earliestRemainingTimeBeforeCommit)</span><br><span class=\"line\"></span><br><span class=\"line\">  let prevInteractions: Set&lt;Interaction&gt; &#x3D; (null: any)</span><br><span class=\"line\"></span><br><span class=\"line\">  &#x2F;&#x2F; Reset this to null before calling lifecycles</span><br><span class=\"line\">  ReactCurrentOwner.current &#x3D; null</span><br><span class=\"line\"></span><br><span class=\"line\">  let firstEffect</span><br><span class=\"line\">  if (finishedWork.effectTag &gt; PerformedWork) &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; A fiber&#39;s effect list consists only of its children, not itself. So if</span><br><span class=\"line\">    &#x2F;&#x2F; the root has an effect, we need to add it to the end of the list. The</span><br><span class=\"line\">    &#x2F;&#x2F; resulting list is the set that would belong to the root&#39;s parent, if</span><br><span class=\"line\">    &#x2F;&#x2F; it had one; that is, all the effects in the tree including the root.</span><br><span class=\"line\">    if (finishedWork.lastEffect !&#x3D;&#x3D; null) &#123;</span><br><span class=\"line\">      finishedWork.lastEffect.nextEffect &#x3D; finishedWork</span><br><span class=\"line\">      firstEffect &#x3D; finishedWork.firstEffect</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">      firstEffect &#x3D; finishedWork</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125; else &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; There is no effect on the root.</span><br><span class=\"line\">    firstEffect &#x3D; finishedWork.firstEffect</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  prepareForCommit(root.containerInfo)</span><br><span class=\"line\"></span><br><span class=\"line\">  &#x2F;&#x2F; Invoke instances of getSnapshotBeforeUpdate before mutation.</span><br><span class=\"line\">  nextEffect &#x3D; firstEffect</span><br><span class=\"line\">  startCommitSnapshotEffectsTimer()</span><br><span class=\"line\">  while (nextEffect !&#x3D;&#x3D; null) &#123;</span><br><span class=\"line\">    let didError &#x3D; false</span><br><span class=\"line\">    let error</span><br><span class=\"line\">    if (__DEV__) &#123;</span><br><span class=\"line\">      invokeGuardedCallback(null, commitBeforeMutationLifecycles, null)</span><br><span class=\"line\">      if (hasCaughtError()) &#123;</span><br><span class=\"line\">        didError &#x3D; true</span><br><span class=\"line\">        error &#x3D; clearCaughtError()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">      try &#123;</span><br><span class=\"line\">        commitBeforeMutationLifecycles()</span><br><span class=\"line\">      &#125; catch (e) &#123;</span><br><span class=\"line\">        didError &#x3D; true</span><br><span class=\"line\">        error &#x3D; e</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if (didError) &#123;</span><br><span class=\"line\">      invariant(</span><br><span class=\"line\">        nextEffect !&#x3D;&#x3D; null,</span><br><span class=\"line\">        &#39;Should have next effect. This error is likely caused by a bug &#39; +</span><br><span class=\"line\">          &#39;in React. Please file an issue.&#39;,</span><br><span class=\"line\">      )</span><br><span class=\"line\">      captureCommitPhaseError(nextEffect, error)</span><br><span class=\"line\">      &#x2F;&#x2F; Clean-up</span><br><span class=\"line\">      if (nextEffect !&#x3D;&#x3D; null) &#123;</span><br><span class=\"line\">        nextEffect &#x3D; nextEffect.nextEffect</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  stopCommitSnapshotEffectsTimer()</span><br><span class=\"line\"></span><br><span class=\"line\">  nextEffect &#x3D; firstEffect</span><br><span class=\"line\">  startCommitHostEffectsTimer()</span><br><span class=\"line\">  while (nextEffect !&#x3D;&#x3D; null) &#123;</span><br><span class=\"line\">    let didError &#x3D; false</span><br><span class=\"line\">    let error</span><br><span class=\"line\">    if (__DEV__) &#123;</span><br><span class=\"line\">      invokeGuardedCallback(null, commitAllHostEffects, null)</span><br><span class=\"line\">      if (hasCaughtError()) &#123;</span><br><span class=\"line\">        didError &#x3D; true</span><br><span class=\"line\">        error &#x3D; clearCaughtError()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">      try &#123;</span><br><span class=\"line\">        commitAllHostEffects()</span><br><span class=\"line\">      &#125; catch (e) &#123;</span><br><span class=\"line\">        didError &#x3D; true</span><br><span class=\"line\">        error &#x3D; e</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if (didError) &#123;</span><br><span class=\"line\">      invariant(</span><br><span class=\"line\">        nextEffect !&#x3D;&#x3D; null,</span><br><span class=\"line\">        &#39;Should have next effect. This error is likely caused by a bug &#39; +</span><br><span class=\"line\">          &#39;in React. Please file an issue.&#39;,</span><br><span class=\"line\">      )</span><br><span class=\"line\">      captureCommitPhaseError(nextEffect, error)</span><br><span class=\"line\">      &#x2F;&#x2F; Clean-up</span><br><span class=\"line\">      if (nextEffect !&#x3D;&#x3D; null) &#123;</span><br><span class=\"line\">        nextEffect &#x3D; nextEffect.nextEffect</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  stopCommitHostEffectsTimer()</span><br><span class=\"line\"></span><br><span class=\"line\">  resetAfterCommit(root.containerInfo)</span><br><span class=\"line\"></span><br><span class=\"line\">  root.current &#x3D; finishedWork</span><br><span class=\"line\"></span><br><span class=\"line\">  nextEffect &#x3D; firstEffect</span><br><span class=\"line\">  startCommitLifeCyclesTimer()</span><br><span class=\"line\">  while (nextEffect !&#x3D;&#x3D; null) &#123;</span><br><span class=\"line\">    let didError &#x3D; false</span><br><span class=\"line\">    let error</span><br><span class=\"line\">    if (__DEV__) &#123;</span><br><span class=\"line\">      invokeGuardedCallback(</span><br><span class=\"line\">        null,</span><br><span class=\"line\">        commitAllLifeCycles,</span><br><span class=\"line\">        null,</span><br><span class=\"line\">        root,</span><br><span class=\"line\">        committedExpirationTime,</span><br><span class=\"line\">      )</span><br><span class=\"line\">      if (hasCaughtError()) &#123;</span><br><span class=\"line\">        didError &#x3D; true</span><br><span class=\"line\">        error &#x3D; clearCaughtError()</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">      try &#123;</span><br><span class=\"line\">        commitAllLifeCycles(root, committedExpirationTime)</span><br><span class=\"line\">      &#125; catch (e) &#123;</span><br><span class=\"line\">        didError &#x3D; true</span><br><span class=\"line\">        error &#x3D; e</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    if (didError) &#123;</span><br><span class=\"line\">      invariant(</span><br><span class=\"line\">        nextEffect !&#x3D;&#x3D; null,</span><br><span class=\"line\">        &#39;Should have next effect. This error is likely caused by a bug &#39; +</span><br><span class=\"line\">          &#39;in React. Please file an issue.&#39;,</span><br><span class=\"line\">      )</span><br><span class=\"line\">      captureCommitPhaseError(nextEffect, error)</span><br><span class=\"line\">      if (nextEffect !&#x3D;&#x3D; null) &#123;</span><br><span class=\"line\">        nextEffect &#x3D; nextEffect.nextEffect</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  isCommitting &#x3D; false</span><br><span class=\"line\">  isWorking &#x3D; false</span><br><span class=\"line\">  stopCommitLifeCyclesTimer()</span><br><span class=\"line\">  stopCommitTimer()</span><br><span class=\"line\">  onCommitRoot(finishedWork.stateNode)</span><br><span class=\"line\"></span><br><span class=\"line\">  const updateExpirationTimeAfterCommit &#x3D; finishedWork.expirationTime</span><br><span class=\"line\">  const childExpirationTimeAfterCommit &#x3D; finishedWork.childExpirationTime</span><br><span class=\"line\">  const earliestRemainingTimeAfterCommit &#x3D;</span><br><span class=\"line\">    updateExpirationTimeAfterCommit &#x3D;&#x3D;&#x3D; NoWork ||</span><br><span class=\"line\">    (childExpirationTimeAfterCommit !&#x3D;&#x3D; NoWork &amp;&amp;</span><br><span class=\"line\">      childExpirationTimeAfterCommit &lt; updateExpirationTimeAfterCommit)</span><br><span class=\"line\">      ? childExpirationTimeAfterCommit</span><br><span class=\"line\">      : updateExpirationTimeAfterCommit</span><br><span class=\"line\">  if (earliestRemainingTimeAfterCommit &#x3D;&#x3D;&#x3D; NoWork) &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; If there&#39;s no remaining work, we can clear the set of already failed</span><br><span class=\"line\">    &#x2F;&#x2F; error boundaries.</span><br><span class=\"line\">    legacyErrorBoundariesThatAlreadyFailed &#x3D; null</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  onCommit(root, earliestRemainingTimeAfterCommit)</span><br><span class=\"line\"></span><br><span class=\"line\">  &#x2F;&#x2F; profiler 相关</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>","prev":{"title":"http常见消息头","link":"2019/12/06/note/http常见消息头"},"next":{"title":"07.React源码学习-beginWork","link":"2019/12/01/note/07-React源码学习-beginWork"},"plink":"https://www.hansomezao.com/2019/12/02/note/08-React源码学习-commit/","toc":[{"id":"commit","title":"commit","index":"1"}]}