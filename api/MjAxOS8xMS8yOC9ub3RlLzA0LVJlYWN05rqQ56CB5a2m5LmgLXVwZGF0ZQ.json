{"title":"04.React源码学习-update","date":"2019-11-28T10:26:29.000Z","date_formatted":{"ll":"2019年11月28日","L":"2019/11/28","MM-DD":"11-28"},"author":"zao","link":"2019/11/28/note/04-React源码学习-update","tags":["react源码"],"categories":["note"],"updated":"2019-11-28T10:26:29.000Z","content":"<h2 id=\"update\">update<a href=\"#update\" title=\"update\"></a></h2><h3 id=\"什么是update\">什么是update<a href=\"#什么是update\" title=\"什么是update\"></a></h3><ul><li>用于记录组件状态的改变</li>\n<li>存放于updateQueue中</li>\n<li>多个update可以同时存在</li>\n</ul><h3 id=\"如何创建update\">如何创建update<a href=\"#如何创建update\" title=\"如何创建update\"></a></h3><p>源码在 react-reconciler 下的 ReactUpdateQueue.js 内：</p>\n<p>创建update:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export function createUpdate(expirationTime: ExpirationTime): Update&lt;*&gt; &#123;</span><br><span class=\"line\">  return &#123;</span><br><span class=\"line\">      &#x2F;&#x2F; 更新的过期时间</span><br><span class=\"line\">    expirationTime: expirationTime,</span><br><span class=\"line\">      &#x2F;&#x2F; export const UpdateState &#x3D; 0;</span><br><span class=\"line\">      &#x2F;&#x2F; export const ReplaceState &#x3D; 1;</span><br><span class=\"line\">      &#x2F;&#x2F; export const ForceUpdate &#x3D; 2;</span><br><span class=\"line\">      &#x2F;&#x2F; export const CaptureUpdate &#x3D; 3;</span><br><span class=\"line\">      &#x2F;&#x2F; 指定更新的类型，值为以上几种</span><br><span class=\"line\">    tag: UpdateState,</span><br><span class=\"line\">      &#x2F;&#x2F; 更新内容，比如&#96;setState&#96;接收的第一个参数</span><br><span class=\"line\">    payload: null,</span><br><span class=\"line\">      &#x2F;&#x2F; 对应的回调，&#96;setState&#96;，&#96;render&#96;都有</span><br><span class=\"line\">    callback: null,</span><br><span class=\"line\">      &#x2F;&#x2F; 指向下一个更新</span><br><span class=\"line\">    next: null,</span><br><span class=\"line\">      &#x2F;&#x2F; 指向下一个&#96;side effect&#96;</span><br><span class=\"line\">    nextEffect: null,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>创建updateQueue:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export function createUpdateQueue&lt;State&gt;(baseState: State): UpdateQueue&lt;State&gt; &#123;</span><br><span class=\"line\">  const queue: UpdateQueue&lt;State&gt; &#x3D; &#123;</span><br><span class=\"line\">      &#x2F;&#x2F; 每次操作完更新之后的&#96;state&#96;</span><br><span class=\"line\">    baseState,</span><br><span class=\"line\">      &#x2F;&#x2F; 队列中的第一个和最后一个&#96;Update&#96;</span><br><span class=\"line\">    firstUpdate: null,</span><br><span class=\"line\">    lastUpdate: null,</span><br><span class=\"line\">      &#x2F;&#x2F; 第一个和最后一个捕获类型的&#96;Update&#96;</span><br><span class=\"line\">    firstCapturedUpdate: null,</span><br><span class=\"line\">    lastCapturedUpdate: null,</span><br><span class=\"line\">      &#x2F;&#x2F; 第一个和最后一个&#96;side effect&#96;</span><br><span class=\"line\">    firstEffect: null,</span><br><span class=\"line\">    lastEffect: null,</span><br><span class=\"line\">      &#x2F;&#x2F; 第一个和最后一个捕获产生的&#96;side effect&#96;</span><br><span class=\"line\">    firstCapturedEffect: null,</span><br><span class=\"line\">    lastCapturedEffect: null,</span><br><span class=\"line\">  &#125;;</span><br><span class=\"line\">  return queue;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","prev":{"title":"05.React源码学习-expirationTime","link":"2019/11/29/note/05-React源码学习-expirationTime"},"next":{"title":"03.React源码学习-FiberRoot与Fiber","link":"2019/11/27/note/03-React源码学习-FiberRoot与Fiber"},"plink":"https://www.hansomezao.com/2019/11/28/note/04-React源码学习-update/","toc":[{"id":"update","title":"update","index":"1","children":[{"id":"什么是update","title":"什么是update","index":"1.1"},{"id":"如何创建update","title":"如何创建update","index":"1.2"}]}]}